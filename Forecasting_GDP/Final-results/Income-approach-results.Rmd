---
title: "Forecasting Australian GDP"
output: 
  pdf_document: 
    keep_tex: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(fpp2)
require(readxl)
require(hts)
library(zoo)
library(magrittr)
library(Matrix)
library(seasonal)
library(gridExtra)
library(ggplot2)
library(kableExtra)
setwd("C:/Puwasala/PhD_Monash/Research/Hierarchical-Book-Chapter/Forecasting_GDP/Final-results")
```

# Income Approach - Point forecasting

```{r echo=FALSE}
load("Income-approach/PointForecasts-ExpandingW.RData")
```

## Summary of GDP - The most aggregate series
```{r echo=FALSE}
Method_Order <- c("Benchmark", "Base", "Bottom-up", "OLS", "WLS", "MinT Shrink")

#For GDP

#ETS
GDPI_PointF_ets <- Score_ets %>% dplyr::filter(`Series`=="Gdpi") 

GDPI_PointF_ets %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`MSE`) %>% as_vector() -> GDPI_ETS.base_MSE

GDPI_PointF_ets %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`MASE`) %>% as_vector() -> GDPI_ETS.base_MASE

GDPI_PointF_ets %>% mutate(SS_MSE = round((1-(`MSE`/GDPI_ETS.base_MSE))*100, digits = 2), 
                           SS_MASE = round((1-(`MASE`/GDPI_ETS.base_MASE))*100, digits = 2)) -> Skill.Score_GDPI_ETS 

SS.GDPI_ETS_MSE <- Skill.Score_GDPI_ETS %>% dplyr::select(`F-method`, `R-method`, `Forecast Horizon`, `SS_MSE` ) %>% 
  spread(key = `Forecast Horizon`, value = `SS_MSE`) %>% 
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>%
  dplyr::select(-`F-method`) %>%  
  rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) 


SS.GDPI_ETS_MASE <- Skill.Score_GDPI_ETS %>% dplyr::select(`F-method`, `R-method`, `Forecast Horizon`, `SS_MASE` ) %>% 
  spread(key = `Forecast Horizon`, value = `SS_MASE`) %>% 
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>%
  dplyr::select(-`F-method`) %>%  
  rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) 


#ARIMA
GDPI_PointF_arima <- Score_arima %>% dplyr::filter(`Series`=="Gdpi") 

GDPI_PointF_arima %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`MSE`) %>% as_vector() -> GDPI_ARIMA.base_MSE

GDPI_PointF_arima %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`MASE`) %>% as_vector() -> GDPI_ARIMA.base_MASE

GDPI_PointF_arima %>% mutate(SS_MSE = round((1-(`MSE`/GDPI_ARIMA.base_MSE))*100, digits = 2), 
                           SS_MASE = round((1-(`MASE`/GDPI_ARIMA.base_MASE))*100, digits = 2)) -> Skill.Score_GDPI_ARIMA 

SS.GDPI_ARIMA_MSE <- Skill.Score_GDPI_ARIMA %>% dplyr::select(`F-method`, `R-method`, `Forecast Horizon`, `SS_MSE` ) %>% 
  spread(key = `Forecast Horizon`, value = `SS_MSE`) %>% 
  mutate(`R-method` = replace(`R-method`, 6, "Benchmark")) %>%
  dplyr::select(-`F-method`) %>%  
  rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) 


SS.GDPI_ARIMA_MASE <- Skill.Score_GDPI_ARIMA %>% 
  dplyr::select(`F-method`, `R-method`, `Forecast Horizon`, `SS_MASE` ) %>% 
  spread(key = `Forecast Horizon`, value = `SS_MASE`) %>% 
  mutate(`R-method` = replace(`R-method`, 6, "Benchmark")) %>%
  dplyr::select(-`F-method`) %>%  
  rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) 


GDPI_PointF <- cbind(SS.GDPI_ETS_MSE, SS.GDPI_ETS_MASE[,-1], SS.GDPI_ARIMA_MSE[,-1], SS.GDPI_ARIMA_MASE[,-1]) %>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "MSE" = 4, "MASE" = 4, "MSE" = 4, "MASE" = 4)) %>%
  kableExtra::add_header_above(c(" " = 1, "ETS" = 8, "ARIMA" = 8))

GDPI_PointF
```


### Summary of all aggregate level series

```{r, echo=FALSE}

#ETS

Score_ets %>% dplyr::filter(`Series` %in% c(names(Inc)[1:6])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_MSE = round(mean(`MSE`), digits = 2), Avg_MASE = round(mean(`MASE`), digits = 2)) -> Score_aggregates_ETS

Score_aggregates_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MSE`) %>% as_vector() -> ETS.base_MSE

Score_aggregates_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MASE`) %>% as_vector() -> ETS.base_MASE

Score_aggregates_ETS %>% mutate(SS_MSE = round((1-(`Avg_MSE`/ETS.base_MSE))*100, digits = 2), 
                           SS_MASE = round((1-(`Avg_MASE`/ETS.base_MASE))*100, digits = 2)) -> Skill.Score_aggregates_ETS  


Skill.Score_aggregates_ETS %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MASE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MSE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Aggregates.ETS_MSE

Skill.Score_aggregates_ETS %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MSE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MASE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Aggregates.ETS_MASE

#ARIMA

Score_arima %>% dplyr::filter(`Series` %in% c(names(Inc)[1:6])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_MSE = round(mean(`MSE`), digits = 2), Avg_MASE = round(mean(`MASE`), digits = 2)) -> Score_aggregates_ARIMA

Score_aggregates_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MSE`) %>% as_vector() -> ARIMA.base_MSE

Score_aggregates_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MASE`) %>% as_vector() -> ARIMA.base_MASE

Score_aggregates_ARIMA %>% mutate(SS_MSE = round((1-(`Avg_MSE`/ARIMA.base_MSE))*100, digits = 2), 
                                SS_MASE = round((1-(`Avg_MASE`/ARIMA.base_MASE))*100, digits = 2)) -> Skill.Score_aggregates_ARIMA  


Skill.Score_aggregates_ARIMA %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MASE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MSE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 6, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Aggregates.ARIMA_MSE

Skill.Score_aggregates_ARIMA %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MSE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MASE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 6, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Aggregates.ARIMA_MASE

Aggregate_PointF <- cbind(Aggregates.ETS_MSE, Aggregates.ETS_MASE[,-1], Aggregates.ARIMA_MSE[,-1], Aggregates.ARIMA_MASE[,-1]) %>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "MSE" = 4, "MASE" = 4, "MSE" = 4, "MASE" = 4)) %>%
  kableExtra::add_header_above(c(" " = 1, "ETS" = 8, "ARIMA" = 8))

Aggregate_PointF
```


## Summary of all disaggregate series
```{r echo=FALSE}
#ETS

Score_ets %>% dplyr::filter(`Series` %in% c(names(Inc)[7:16])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_MSE = round(mean(`MSE`), digits = 2), Avg_MASE = round(mean(`MASE`), digits = 2)) -> Score_disaggregates_ETS

Score_disaggregates_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MSE`) %>% as_vector() -> ETS.base_MSE

Score_disaggregates_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MASE`) %>% as_vector() -> ETS.base_MASE

Score_disaggregates_ETS %>% mutate(SS_MSE = round((1-(`Avg_MSE`/ETS.base_MSE))*100, digits = 2), 
                                SS_MASE = round((1-(`Avg_MASE`/ETS.base_MASE))*100, digits = 2)) -> Skill.Score_disaggregates_ETS  


Skill.Score_disaggregates_ETS %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MASE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MSE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Disaggregates.ETS_MSE

Skill.Score_disaggregates_ETS %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MSE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MASE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Disaggregates.ETS_MASE

#ARIMA

Score_arima %>% dplyr::filter(`Series` %in% c(names(Inc)[7:16])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_MSE = round(mean(`MSE`), digits = 2), Avg_MASE = round(mean(`MASE`), digits = 2)) -> Score_disaggregates_ARIMA

Score_disaggregates_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MSE`) %>% as_vector() -> ARIMA.base_MSE

Score_disaggregates_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MASE`) %>% as_vector() -> ARIMA.base_MASE

Score_disaggregates_ARIMA %>% mutate(SS_MSE = round((1-(`Avg_MSE`/ARIMA.base_MSE))*100, digits = 2), 
                                  SS_MASE = round((1-(`Avg_MASE`/ARIMA.base_MASE))*100, digits = 2)) -> Skill.Score_disaggregates_ARIMA  


Skill.Score_disaggregates_ARIMA %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MASE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MSE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 6, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Disaggregates.ARIMA_MSE

Skill.Score_disaggregates_ARIMA %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MSE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MASE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 6, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Disaggregates.ARIMA_MASE

Disaggregate_PointF <- cbind(Disaggregates.ETS_MSE, Disaggregates.ETS_MASE[,-1], Disaggregates.ARIMA_MSE[,-1], Disaggregates.ARIMA_MASE[,-1]) %>%
  kable(format = "latex") %>% kable_styling("striped") %>%
  kableExtra::add_header_above(c(" " = 1, "MSE" = 4, "MASE" = 4, "MSE" = 4, "MASE" = 4)) %>%
  kableExtra::add_header_above(c(" " = 1, "ETS" = 8, "ARIMA" = 8))


Disaggregate_PointF
```

## Summary of all series in the hierarchy (Average over all series)
```{r echo=FALSE}
#ETS

Score_ets %>% dplyr::select(-`Series`) %>% 
  group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_MSE = round(mean(`MSE`), digits = 2), Avg_MASE = round(mean(`MASE`), digits = 2)) -> Score_all.series_ETS

Score_all.series_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MSE`) %>% as_vector() -> ETS.base_MSE

Score_all.series_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MASE`) %>% as_vector() -> ETS.base_MASE

Score_all.series_ETS %>% mutate(SS_MSE = round((1-(`Avg_MSE`/ETS.base_MSE))*100, digits = 2), 
                                   SS_MASE = round((1-(`Avg_MASE`/ETS.base_MASE))*100, digits = 2)) -> Skill.Score_all.series_ETS  


Skill.Score_all.series_ETS %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MASE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MSE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> All.series.ETS_MSE

Skill.Score_all.series_ETS %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MSE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MASE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> All.series.ETS_MASE

#ARIMA

Score_arima %>% dplyr::select(-`Series`) %>% 
  group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_MSE = round(mean(`MSE`), digits = 2), Avg_MASE = round(mean(`MASE`), digits = 2)) -> Score_all.series_ARIMA

Score_all.series_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MSE`) %>% as_vector() -> ARIMA.base_MSE

Score_all.series_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_MASE`) %>% as_vector() -> ARIMA.base_MASE

Score_all.series_ARIMA %>% mutate(SS_MSE = round((1-(`Avg_MSE`/ARIMA.base_MSE))*100, digits = 2), 
                                     SS_MASE = round((1-(`Avg_MASE`/ARIMA.base_MASE))*100, digits = 2)) -> Skill.Score_all.series_ARIMA  


Skill.Score_all.series_ARIMA %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MASE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MSE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 6, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> All.series.ARIMA_MSE

Skill.Score_all.series_ARIMA %>% dplyr::select(-`Avg_MASE`, -`Avg_MSE`, -`SS_MSE`) %>% 
  spread(key = `Forecast Horizon`, value = SS_MASE) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 6, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> All.series.ARIMA_MASE

All.series_PointF <- cbind(All.series.ETS_MSE, All.series.ETS_MASE[,-1], All.series.ARIMA_MSE[,-1], All.series.ARIMA_MASE[,-1]) %>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "MSE" = 4, "MASE" = 4, "MSE" = 4, "MASE" = 4)) %>%
  kableExtra::add_header_above(c(" " = 1, "ETS" = 8, "ARIMA" = 8))


All.series_PointF
```



# Income approach - Probabilistic forecasting (Non-parametric Bootstrap approach)

```{r echo=FALSE}

load("Income-approach/ProbForecasts-BootstrapApproach-ExpandingW.RData")

```

## Predictive ability of multivariate forecast distribution of the whole hierarchy
```{r echo=FALSE}

Method_Order <- c("Benchmark", "Base", "Bottom-up", "OLS", "WLS", "MinT Sample", "MinT Shrink")

#ETS
SS_E.ES_ETS %>% ungroup() %>% 
  mutate(`R-method` = replace(`R-method`, list = c(1, 3, 4, 5), c("Benchmark", "Bottom-up", "MinT Sample", "MinT Shrink"))) %>%
  dplyr::select(-`F-method`) %>%  
  rename("Method" = "R-method") %>% slice(match(Method_Order, `Method`)) -> ETS_ES

SS_E.VS_ETS %>% ungroup() %>% 
  mutate(`R-method` = replace(`R-method`, list = c(1, 3, 4, 5), c("Benchmark", "Bottom-up", "MinT Sample", "MinT Shrink"))) %>%
  dplyr::select(-`F-method`) %>%  
  rename("Method" = "R-method") %>% slice(match(Method_Order, `Method`)) -> ETS_VS

#ARIMA
SS_E.ES_ARIMA %>% ungroup() %>% 
  mutate(`R-method` = replace(`R-method`, list = c(2, 3, 4, 7), c("Bottom-up", "MinT Sample", "MinT Shrink",
                                                                  "Benchmark"))) %>%
  dplyr::select(-`F-method`) %>%  
  rename("Method" = "R-method") %>% slice(match(Method_Order, `Method`)) -> ARIMA_ES

SS_E.VS_ARIMA %>% ungroup() %>% 
  mutate(`R-method` = replace(`R-method`, list = c(2, 3, 4, 7), c("Bottom-up", "MinT Sample", "MinT Shrink",
                                                                  "Benchmark"))) %>%
  dplyr::select(-`F-method`) %>%  
  rename("Method" = "R-method") %>% slice(match(Method_Order, `Method`)) -> ARIMA_VS

#Combining the columns
NonPara_ProbF_Multivariate <- cbind(ETS_ES, ETS_VS[,-1], ARIMA_ES[,-1], ARIMA_VS[,-1]) %>%
  kable(format = "latex", digits = 2) %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "ES" = 4, "VS" = 4, "ES" = 4, "VS" = 4)) %>%
  kableExtra::add_header_above(c(" " = 1, "ETS" = 8, "ARIMA" = 8))

NonPara_ProbF_Multivariate
```

## Predictive ability of univariate forecast distributions

### Summary of GDP - The most aggregate series
```{r echo=FALSE}
#For GDP

#ETS
Score_ets %>% dplyr::filter(`Series` == "Gdpi") -> Score_GDPI_ETS

Score_GDPI_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`MCRPS`) %>% as_vector() -> GDPI_ETS.base_CRPS

Score_GDPI_ETS %>% 
  mutate(SS_CRPS = round((1-(`MCRPS`/GDPI_ETS.base_CRPS))*100, digits = 2)) -> Skill.Score_GDPI_ETS  


Skill.Score_GDPI_ETS %>% dplyr::select(-`MCRPS`, -`Series`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, c(1, 3), c("Benchmark", "Bottom-up"))) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> GDPI.ETS_CRPS


#ARIMA
Score_arima %>% dplyr::filter(`Series` == "Gdpi") -> Score_GDPI_ARIMA

Score_GDPI_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`MCRPS`) %>% as_vector() -> GDPI_ARIMA.base_CRPS

Score_GDPI_ARIMA %>% 
  mutate(SS_CRPS = round((1-(`MCRPS`/GDPI_ARIMA.base_CRPS))*100, digits = 2)) -> Skill.Score_GDPI_ARIMA 


Skill.Score_GDPI_ARIMA %>% dplyr::select(-`MCRPS`, -`Series`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, c(7, 2), c("Benchmark", "Bottom-up"))) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> GDPI.ARIMA_CRPS

GDPI_ProbF_NonPara <- cbind(GDPI.ETS_CRPS, GDPI.ARIMA_CRPS[,-1]) %>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "ETS (CRPS)" = 4, "ARIMA (CRPS)" = 4))

GDPI_ProbF_NonPara

```

### Summary of all aggregate level series

```{r echo=FALSE}
#ETS

Score_ets %>% dplyr::filter(`Series` %in% c(names(Inc)[1:6])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2)) -> Score_aggregates_ETS

Score_aggregates_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ETS.base_CRPS

Score_aggregates_ETS %>% 
  mutate(SS_CRPS = round((1-(`Avg_CRPS`/ETS.base_CRPS))*100, digits = 2)) -> Skill.Score_aggregates_ETS  


Skill.Score_aggregates_ETS %>% dplyr::select(-`Avg_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Aggregates.ETS_CRPS

#ARIMA

Score_arima %>% dplyr::filter(`Series` %in% c(names(Inc)[1:6])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2)) -> Score_aggregates_ARIMA

Score_aggregates_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ARIMA.base_CRPS

Score_aggregates_ARIMA %>% 
  mutate(SS_CRPS = round((1-(`Avg_CRPS`/ARIMA.base_CRPS))*100, digits = 2)) -> Skill.Score_aggregates_ARIMA  


Skill.Score_aggregates_ARIMA %>% dplyr::select(-`Avg_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Aggregates.ARIMA_CRPS

Aggregate_ProbF_NonPara <- cbind(Aggregates.ETS_CRPS, Aggregates.ARIMA_CRPS[,-1]) %>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "ETS (CRPS)" = 4, "ARIMA (CRPS)" = 4)) 


Aggregate_ProbF_NonPara

```


### Summary of all disaggregate series
```{r echo=FALSE}
#ETS

Score_ets %>% dplyr::filter(`Series` %in% c(names(Inc)[7:16])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2)) -> Score_disaggregates_ETS

Score_disaggregates_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ETS.base_CRPS

Score_disaggregates_ETS %>% 
  mutate(SS_CRPS = round((1-(`Avg_CRPS`/ETS.base_CRPS))*100, digits = 2)) -> Skill.Score_disaggregates_ETS  


Skill.Score_disaggregates_ETS %>% dplyr::select(-`Avg_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Disaggregates.ETS_CRPS

#ARIMA

Score_arima %>% dplyr::filter(`Series` %in% c(names(Inc)[7:16])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2)) -> Score_disaggregates_ARIMA

Score_disaggregates_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ARIMA.base_CRPS

Score_disaggregates_ARIMA %>% 
  mutate(SS_CRPS = round((1-(`Avg_CRPS`/ARIMA.base_CRPS))*100, digits = 2)) -> Skill.Score_disaggregates_ARIMA  


Skill.Score_disaggregates_ARIMA %>% dplyr::select(-`Avg_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Disaggregates.ARIMA_CRPS

 Disaggregate_ProbF_NonPara <- cbind(Disaggregates.ETS_CRPS, Disaggregates.ARIMA_CRPS[,-1]) %>% 
   kable(format = "latex") %>% kable_styling("striped") %>% 
   kableExtra::add_header_above(c(" " = 1, "ETS (CRPS)" = 4, "ARIMA (CRPS)" = 4)) 
 

 Disaggregate_ProbF_NonPara
```

### Summary of all series in the hierarchy
```{r echo=FALSE}

#ETS

Score_ets %>% dplyr::select(-`Series`) %>% 
  group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2)) -> Score_all.series_ETS

Score_all.series_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ETS.base_CRPS

Score_all.series_ETS %>% 
  mutate(SS_CRPS = round((1-(`Avg_CRPS`/ETS.base_CRPS))*100, digits = 2)) -> Skill.Score_all.series_ETS  


Skill.Score_all.series_ETS %>% dplyr::select(-`Avg_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> All.series.ETS_CRPS

#ARIMA

Score_arima %>% dplyr::select(-`Series`) %>% 
  group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2)) -> Score_all.series_ARIMA

Score_all.series_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ARIMA.base_CRPS

Score_all.series_ARIMA %>% 
  mutate(SS_CRPS = round((1-(`Avg_CRPS`/ARIMA.base_CRPS))*100, digits = 2)) -> Skill.Score_all.series_ARIMA  


Skill.Score_all.series_ARIMA %>% dplyr::select(-`Avg_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> All.series.ARIMA_CRPS


All.series_ProbF_NonPara <- cbind(All.series.ETS_CRPS, All.series.ARIMA_CRPS[,-1]) %>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "ETS (CRPS)" = 4, "ARIMA (CRPS)" = 4)) 


All.series_ProbF_NonPara
```


# Income approach - Probabilistic forecasting (Parametric approach assuming Gaussianity)

```{r echo=FALSE}

load("Income-approach/ProbForecasts-GaussianApproach-ExpandingW.RData")

```

## Predictive ability in the multivariate forecast distribution of the whole hierarchy
```{r echo=FALSE}

Method_Order <- c("Benchmark", "Base", "Bottom-up", "OLS", "WLS", "MinT Sample", "MinT Shrink")

#ETS
SS_E.ES_ETS %>% ungroup() %>% 
  mutate(`R-method` = replace(`R-method`, list = c(1, 3, 4, 5), c("Benchmark", "Bottom-up", "MinT Sample", "MinT Shrink"))) %>%
  dplyr::select(-`F-method`) %>%  
  rename("Method" = "R-method") %>% slice(match(Method_Order, `Method`)) -> ETS_ES

SS_E.VS_ETS %>% ungroup() %>% 
  mutate(`R-method` = replace(`R-method`, list = c(1, 3, 4, 5), c("Benchmark", "Bottom-up", "MinT Sample", "MinT Shrink"))) %>% 
  dplyr::select(-`F-method`) %>% 
  rename("Method" = "R-method") %>% slice(match(Method_Order, `Method`)) -> ETS_VS

#ARIMA
SS_E.ES_ARIMA %>% ungroup() %>% 
  mutate(`R-method` = replace(`R-method`, list = c(2, 3, 4, 7), c("Bottom-up", "MinT Sample", "MinT Shrink", "Benchmark"))) %>%
  dplyr::select(-`F-method`) %>%  
  rename("Method" = "R-method") %>% slice(match(Method_Order, `Method`)) -> ARIMA_ES

SS_E.VS_ARIMA %>% ungroup() %>% 
  mutate(`R-method` = replace(`R-method`, list = c(2, 3, 4, 7), c("Bottom-up", "MinT Sample", "MinT Shrink", "Benchmark"))) %>%
  dplyr::select(-`F-method`) %>% 
  rename("Method" = "R-method") %>% slice(match(Method_Order, `Method`)) -> ARIMA_VS

#Combining the columns
Gaus_ProbF_Multivariate <- cbind(ETS_ES, ETS_VS[,-1], ARIMA_ES[,-1], ARIMA_VS[,-1]) %>% 
  kable(format = "latex", digits = 2) %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "ES" = 4, "VS" = 4, "ES" = 4, "VS" = 4)) %>%
  kableExtra::add_header_above(c(" " = 1, "ETS" = 8, "ARIMA" = 8))

Gaus_ProbF_Multivariate

##With log scores

DF_MultScore_SS_ETS_LS %>% ungroup() %>% select(-`F-method`) %>% rename("Method" = "R-method") %>%
  mutate(`Method` = replace(`Method`, c(1, 2, 3), c("Bottom-up", "MinT Sample", "MinT Shrink"))) %>%
  slice(match(Method_Order[3:7], `Method`)) -> ETS_LS

DF_MultScore_SS_ARIMA_LS %>% ungroup() %>% select(-`F-method`) %>% rename("Method" = "R-method") %>%
  mutate(`Method` = replace(`Method`, c(1, 2, 3), c("Bottom-up", "MinT Sample", "MinT Shrink"))) %>%
  slice(match(Method_Order[3:7], `Method`)) -> ARIMA_LS

#Combining the columns
Gaus_ProbF_Multivariate_LS <- cbind(ETS_LS, ARIMA_LS[,-1]) %>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "ETS" = 4, "ARIMA" = 4))

Gaus_ProbF_Multivariate_LS

DF_MultiV %>% dplyr::select(-`Energy score`, -`Variogram score`) %>% 
  filter(`Log score` != "NA") %>% 
  filter(`F-method` == "ETS") -> DF_Mult_LS_ETS

DF_Mult_LS_ETS %>% ggplot(aes(x = `Replication`, y = `Log score`, color = `R-method`)) + 
  geom_line() + facet_wrap(~`Forecast Horizon`, scales = "free_y") + ggtitle("Multivariate log scores for ETS method")

DF_MultiV %>% dplyr::select(-`Energy score`, -`Variogram score`) %>% 
  filter(`Log score` != "NA") %>% 
  filter(`F-method` == "ARIMA") -> DF_Mult_LS_ARIMA

DF_Mult_LS_ARIMA %>% ggplot(aes(x = `Replication`, y = `Log score`, color = `R-method`)) + 
  geom_line() + facet_wrap(~`Forecast Horizon`, scales = "free_y") + ggtitle("Multivariate log scores for ARIMA method")

```

## Predictive ability of univariate forecast distributions

### Summary of GDP - The most aggregate series
```{r echo=FALSE}
#For GDP

#ETS
Score_ets %>% dplyr::filter(`Series`=="Gdpi" ) -> Score_GDPI_ETS

Score_GDPI_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`MCRPS`) %>% as_vector() -> GDPI_ETS.base_CRPS

Score_GDPI_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`MLS`) %>% as_vector() -> GDPI_ETS.base_LS

Score_GDPI_ETS %>% mutate(SS_CRPS = round((1-(`MCRPS`/GDPI_ETS.base_CRPS))*100, digits = 2), 
                                SS_LS = round((1-(`MLS`/GDPI_ETS.base_LS))*100, digits = 2)) -> Skill.Score_GDPI_ETS  


Skill.Score_GDPI_ETS %>% dplyr::select(-`MCRPS`, -`MLS`, -`SS_LS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`, -`Series`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> GDPI.ETS_CRPS

Skill.Score_GDPI_ETS %>% dplyr::select(-`MCRPS`, -`MLS`, -`SS_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_LS) %>% ungroup() %>% dplyr::select(-`F-method`, -`Series`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> GDPI.ETS_LS


#ARIMA
Score_arima %>% dplyr::filter(`Series`=="Gdpi" ) -> Score_GDPI_ARIMA

Score_GDPI_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`MCRPS`) %>% as_vector() -> GDPI_ARIMA.base_CRPS

Score_GDPI_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`MLS`) %>% as_vector() -> GDPI_ARIMA.base_LS

Score_GDPI_ARIMA %>% mutate(SS_CRPS = round((1-(`MCRPS`/GDPI_ARIMA.base_CRPS))*100, digits = 2), 
                                SS_LS = round((1-(`MLS`/GDPI_ARIMA.base_LS))*100, digits = 2)) -> Skill.Score_GDPI_ARIMA 


Skill.Score_GDPI_ARIMA %>% dplyr::select(-`MCRPS`, -`MLS`, -`SS_LS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`, -`Series`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> GDPI.ARIMA_CRPS

Skill.Score_GDPI_ARIMA %>% dplyr::select(-`MCRPS`, -`MLS`, -`SS_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_LS) %>% ungroup() %>% dplyr::select(-`F-method`, -`Series`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> GDPI.ARIMA_LS

GDPI_ProbF_Gaus <- cbind(GDPI.ETS_CRPS, GDPI.ETS_LS[,-1], GDPI.ARIMA_CRPS[,-1], GDPI.ARIMA_LS[,-1]) %>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "CRPS" = 4, "LS" = 4, "CRPS" = 4, "LS" = 4)) %>%
  kableExtra::add_header_above(c(" " = 1, "ETS" = 8, "ARIMA" = 8))

GDPI_ProbF_Gaus


```

### Summary of all aggregate level series

```{r echo=FALSE}

#ETS

Score_ets %>% dplyr::filter(`Series` %in% c(names(Inc)[1:6])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2), Avg_LS = round(mean(`MLS`), digits = 2)) -> Score_aggregates_ETS

Score_aggregates_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ETS.base_CRPS

Score_aggregates_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_LS`) %>% as_vector() -> ETS.base_LS

Score_aggregates_ETS %>% mutate(SS_CRPS = round((1-(`Avg_CRPS`/ETS.base_CRPS))*100, digits = 2), 
                                SS_LS = round((1-(`Avg_LS`/ETS.base_LS))*100, digits = 2)) -> Skill.Score_aggregates_ETS  


Skill.Score_aggregates_ETS %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_LS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Aggregates.ETS_CRPS

Skill.Score_aggregates_ETS %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_LS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Aggregates.ETS_LS

#ARIMA

Score_arima %>% dplyr::filter(`Series` %in% c(names(Inc)[1:6])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2), Avg_LS = round(mean(`MLS`), digits = 2)) -> Score_aggregates_ARIMA

Score_aggregates_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ARIMA.base_CRPS

Score_aggregates_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_LS`) %>% as_vector() -> ARIMA.base_LS

Score_aggregates_ARIMA %>% mutate(SS_CRPS = round((1-(`Avg_CRPS`/ARIMA.base_CRPS))*100, digits = 2), 
                                  SS_LS = round((1-(`Avg_LS`/ARIMA.base_LS))*100, digits = 2)) -> Skill.Score_aggregates_ARIMA  


Skill.Score_aggregates_ARIMA %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_LS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Aggregates.ARIMA_CRPS

Skill.Score_aggregates_ARIMA %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_LS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Aggregates.ARIMA_LS

Aggregate_ProbF_Gauss <- cbind(Aggregates.ETS_CRPS, Aggregates.ETS_LS[,-1], Aggregates.ARIMA_CRPS[,-1], Aggregates.ARIMA_LS[,-1]) %>%
   kable(format = "latex") %>% kable_styling("striped") %>%
   kableExtra::add_header_above(c(" " = 1, "CRPS" = 4, "LS" = 4, "CRPS" = 4, "LS" = 4)) %>%
   kableExtra::add_header_above(c(" " = 1, "ETS" = 8, "ARIMA" = 8))


Aggregate_ProbF_Gauss

```

### Summary of all disaggregate series
```{r echo=FALSE}
#ETS

Score_ets %>% dplyr::filter(`Series` %in% c(names(Inc)[7:16])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2), Avg_LS = round(mean(`MLS`), digits = 2)) -> Score_disaggregates_ETS

Score_disaggregates_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ETS.base_CRPS

Score_disaggregates_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_LS`) %>% as_vector() -> ETS.base_LS

Score_disaggregates_ETS %>% mutate(SS_CRPS = round((1-(`Avg_CRPS`/ETS.base_CRPS))*100, digits = 2), 
                                SS_LS = round((1-(`Avg_LS`/ETS.base_LS))*100, digits = 2)) -> Skill.Score_disaggregates_ETS  


Skill.Score_disaggregates_ETS %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_LS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Disaggregates.ETS_CRPS

Skill.Score_disaggregates_ETS %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_LS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Disaggregates.ETS_LS

#ARIMA

Score_arima %>% dplyr::filter(`Series` %in% c(names(Inc)[7:16])) %>%
  dplyr::select(-`Series`) %>% group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2), Avg_LS = round(mean(`MLS`), digits = 2)) -> Score_disaggregates_ARIMA

Score_disaggregates_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ARIMA.base_CRPS

Score_disaggregates_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_LS`) %>% as_vector() -> ARIMA.base_LS

Score_disaggregates_ARIMA %>% mutate(SS_CRPS = round((1-(`Avg_CRPS`/ARIMA.base_CRPS))*100, digits = 2), 
                                  SS_LS = round((1-(`Avg_LS`/ARIMA.base_LS))*100, digits = 2)) -> Skill.Score_disaggregates_ARIMA  


Skill.Score_disaggregates_ARIMA %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_LS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Disaggregates.ARIMA_CRPS

Skill.Score_disaggregates_ARIMA %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_LS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> Disaggregates.ARIMA_LS


 Disaggregate_ProbF_Gauss <- cbind(Disaggregates.ETS_CRPS, Disaggregates.ETS_LS[,-1], Disaggregates.ARIMA_CRPS[,-1], Disaggregates.ARIMA_LS[,-1]) %>%
   kable(format = "latex") %>% kable_styling("striped") %>%
   kableExtra::add_header_above(c(" " = 1, "CRPS" = 4, "LS" = 4, "CRPS" = 4, "LS" = 4)) %>%
   kableExtra::add_header_above(c(" " = 1, "ETS" = 8, "ARIMA" = 8))


Disaggregate_ProbF_Gauss
```

### Summary of all series in the hierarchy
```{r echo=FALSE}
#ETS

Score_ets %>% dplyr::select(-`Series`) %>% 
  group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2), Avg_LS = round(mean(`MLS`), digits = 2)) -> Score_all.series_ETS

Score_all.series_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ETS.base_CRPS

Score_all.series_ETS %>% dplyr::filter(`F-method`=="ETS", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_LS`) %>% as_vector() -> ETS.base_LS

Score_all.series_ETS %>% mutate(SS_CRPS = round((1-(`Avg_CRPS`/ETS.base_CRPS))*100, digits = 2), 
                                SS_LS = round((1-(`Avg_LS`/ETS.base_LS))*100, digits = 2)) -> Skill.Score_all.series_ETS  


Skill.Score_all.series_ETS %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_LS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> All.series.ETS_CRPS

Skill.Score_all.series_ETS %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_LS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 1, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> All.series.ETS_LS

#ARIMA

Score_arima %>% dplyr::select(-`Series`) %>% 
  group_by(`F-method`, `R-method`, `Forecast Horizon`) %>%
  summarise(Avg_CRPS = round(mean(`MCRPS`), digits = 2), Avg_LS = round(mean(`MLS`), digits = 2)) -> Score_all.series_ARIMA

Score_all.series_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_CRPS`) %>% as_vector() -> ARIMA.base_CRPS

Score_all.series_ARIMA %>% dplyr::filter(`F-method`=="ARIMA", `R-method`=="Base") %>%
  slice() %>% 
  ungroup() %>%
  dplyr::select(`Avg_LS`) %>% as_vector() -> ARIMA.base_LS

Score_all.series_ARIMA %>% mutate(SS_CRPS = round((1-(`Avg_CRPS`/ARIMA.base_CRPS))*100, digits = 2), 
                                  SS_LS = round((1-(`Avg_LS`/ARIMA.base_LS))*100, digits = 2)) -> Skill.Score_all.series_ARIMA  


Skill.Score_all.series_ARIMA %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_LS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_CRPS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> All.series.ARIMA_CRPS

Skill.Score_all.series_ARIMA %>% dplyr::select(-`Avg_CRPS`, -`Avg_LS`, -`SS_CRPS`) %>% 
  spread(key = `Forecast Horizon`, value = SS_LS) %>% ungroup() %>% dplyr::select(-`F-method`) %>%  
  mutate(`R-method` = replace(`R-method`, 7, "Benchmark")) %>% rename("Method" = "R-method") %>%
  slice(match(Method_Order, `Method`)) -> All.series.ARIMA_LS


All.series_ProbF_Gauss <- cbind(All.series.ETS_CRPS, All.series.ETS_LS[,-1], All.series.ARIMA_CRPS[,-1], All.series.ARIMA_LS[,-1]) %>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "CRPS" = 4, "LS" = 4, "CRPS" = 4, "LS" = 4)) %>%
  kableExtra::add_header_above(c(" " = 1, "ETS" = 8, "ARIMA" = 8))


All.series_ProbF_Gauss

#ETS - Plot of avg log scores
DF_UniV %>% filter(`F-method` == "ETS" | `R-method` == "Base") %>%
  dplyr::filter(`F-method` != "ARIMA") %>% 
  dplyr::select(`Series`, `F-method`, `R-method`, `Forecast Horizon`, `LS`, `Replication`) -> DF_UniV_ETS_LS

DF_UniV_ETS_LS %>% ungroup() %>% dplyr::select(-`Series`) %>% 
  group_by(`F-method`, `R-method`, `Forecast Horizon`, `Replication`) %>% 
  summarise(Avg_LS = round(mean(`LS`), digits = 2)) -> DF_UniV_ETS_Avg.LS

DF_UniV_ETS_Avg.LS %>% ggplot(aes(x = `Replication`, y = `Avg_LS`, color = `R-method`)) + 
  geom_line() + facet_wrap(~ `Forecast Horizon`, scales = "free_y") + ggtitle("Average univariate log scores for ETS method")

#ARIMA - Plot of avg log scores
DF_UniV %>% filter(`F-method` == "ARIMA" | `R-method` == "Base") %>%
  dplyr::filter(`F-method` != "ETS") %>% 
  dplyr::select(`Series`, `F-method`, `R-method`, `Forecast Horizon`, `LS`, `Replication`) -> DF_UniV_ARIMA_LS

DF_UniV_ARIMA_LS %>% ungroup() %>% dplyr::select(-`Series`) %>% 
  group_by(`F-method`, `R-method`, `Forecast Horizon`, `Replication`) %>% 
  summarise(Avg_LS = round(mean(`LS`), digits = 2)) -> DF_UniV_ARIMA_Avg.LS

DF_UniV_ARIMA_Avg.LS %>% ggplot(aes(x = `Replication`, y = `Avg_LS`, color = `R-method`)) + 
  geom_line() + facet_wrap(~ `Forecast Horizon`, scales = "free_y") + ggtitle("Average univariate log scores for ARIMA method")

```




